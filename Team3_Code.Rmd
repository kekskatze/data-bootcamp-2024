---
title: "Behind te camera - exposing gender gaps in film direction"
author: "Team 3"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r global_options, include=FALSE}
#knitr::opts_chunk$set(eval=FALSE)
```

```{r setup, include=FALSE, eval=TRUE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir ="C:/Users/marle/Documents/Bootcamp 2024/R")
```

```{r, warning=FALSE, message=FALSE, include=FALSE, eval=TRUE}
library(readr)
library(tidyverse)
library(readxl)
library(stringi)
library(openxlsx)
library(tidyr)
library(haven)
library(plm)
library(zoo)
library(psych)
library(mice)
library(miceadds)
library(broom.mixed)
library(corrplot)
library(psych)
library(GPArotation)
library(texreg)
library(flextable)
library(gridExtra)
library(grid)
library(lemon)
library(data.table)
```


```{r, warning=FALSE, message=FALSE, include=FALSE, eval=TRUE}
nettit <- read.csv("nettit_directors.csv", header=T, sep=",")
net <- read.csv("Netflix.csv", header=T, sep=";")
```

# Basic Tasks

## Exploring Data
### Taks 1: How many countries are in the dataset?
```{r}
unique_countries <- unique(net$Country)
length(unique_countries)

```
### Task 2: What is the average watch time (duration) of this user?
```{r}
net$Duration <- as.ITime(net$Duration)
mean(net$Duration)

```
### Task 3: How many minutes of watch-time has this user in Germany in total?
```{r}

net %>%
  filter(Country == "DE (Germany)") %>%  
  summarise(mean_duration = mean(Duration, na.rm = TRUE)) 


```


### Task 4 and 5: Earliest and latest Start Time
```{r}
min(net$Start.Time, na.rm = TRUE)
max(net$Start.Time, na.rm = TRUE)

```

### Task 6: Which series or movie got clicked on the most? You may need some string formatting to cut out the episode
```{r}
# extract title
extract_title <- function(title) {
    parts <- strsplit(title, ":", fixed = TRUE)[[1]]
    return(parts[1])
}

net$Title <- sapply(net$Title, extract_title)

# Most clicked Titles
title_counts <- table(net$Title)

most_clicked <- names(which.max(title_counts))
print(most_clicked)

sort(title_counts, decreasing = TRUE)[1:10]
```

### Task 7: Which series or movie has the highest watch_time (duration). You may need the string formatting from before and also calculate the total duration watched.
```{r}
dur <- net %>% 
  group_by(Title) %>% 
  summarise(sumdur = sum(Duration))

head(dur[order(dur$sumdur, decreasing = T),])
```

## Visualise the data

### 2. Make a bar plot showing how many entries there are for each country. X-axis: Countries, Y-Axis: Number of Entries

```{r}
ggplot(data=net, mapping=aes(x=Country))+
  geom_bar()
```

### 3. Make a bar plot for the duration watched each month in 2022. X-Axis: Months , Y-Axis: Duration, Title: Watch time per month in 2022.
```{r}
net$Start.Time <- as.POSIXct(net$Start.Time, format = "%Y-%m-%d %H:%M:%S")
net$date <- as.Date(net$Start.Time)
net$month <- format(net$Start.Time, "%B")
net$year <- year(net$Start.Time)

net$Duration <- as.ITime(net$Duration)

net_sub <-  net %>% 
  filter(year==2022) %>% 
  group_by(month) %>% 
  summarize(totdur=sum(Duration))

ggplot(data=net_sub, mapping = aes(x=month, y=totdur)) +
  geom_col()
```


### 4. Make a line plot showing the duration per day for the whole time provided in the dataset. X-Axis: Date, Y-Axis: Duration

```{r}
ggplot(data = net, mapping = aes(x=date, y=Duration)) +
  geom_line()
```

### 5. Make a bar plot for the top 10 series/movies regarding watch_time. X-Axis: Movies/Series, Y-Axis: Duration

```{r}
extract_title <- function(title) {
  parts <- strsplit(title, ":", fixed = TRUE)[[1]]
  return(parts[1])
}
net$Title_x <- sapply(net$Title, extract_title)

net_dur <- net %>% 
  group_by(Title_x) %>% 
  summarize(sumdur=sum(Duration))

net_dur_head <- head(net_dur[order(net_dur$sumdur, decreasing = TRUE), ], 30)

ggplot(data=net_dur_head, mapping = aes(x=Title_x, y=sumdur)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Gender Differences by Genre
```{r}
nettit <- nettit %>% 
  mutate(genderfin=case_when(gender=="mostly_male"|gender=="male" ~ "Male",
                             gender=="mostly_female"|gender=="female" ~ "Female",
                             gender=="unknown" | gender=="andy" ~ "Unknown")) %>% 
  filter(release_year>=2000)
```


```{r}
nettit_genre <- nettit %>% 
  filter(genderfin!="Unknown")

nettit_genre <- separate(nettit_genre, listed_in, into = paste0("genre_x", 1:3), sep = ", ", fill = "right")

nettit_long <- nettit_genre %>%
  pivot_longer(starts_with("genre_"), names_to = "genre", values_to = "is_genre")

nettit_long <- nettit_long %>%
  mutate(genre_fin = ifelse(
    is_genre == "TV Thrillers",
    "Thrillers",
    ifelse(
      is_genre == "International Movies" |
        is_genre == "International TV Shows",
      "International"
    ,
    ifelse(is_genre == "Documentaries" |
             is_genre == "Docuseries",
           "Documentaries",
    ifelse(
      is_genre == "Classic & Cult TV" |
        is_genre == "Classic Movies" |
        is_genre == "Cult Movies",
      "Classic & Cult",
    ifelse(
      is_genre == "Romantic TV Shows" |
        is_genre == "Romantic Movies",
      "Romantic",
    ifelse(
      is_genre == "Anime Features" |
        is_genre == "Anime Series",
      "Anime",
    ifelse(
      is_genre == "Stand-Up Comedy",
      "Stand-Up Comedy & Talk Shows"
      ,
    ifelse(
      is_genre == "TV Sci-Fi & Fantasy",
      "Sci-Fi & Fantasy",
    ifelse(
      is_genre == "TV Action & Adventure",
      "Action & Adventure"
      ,ifelse(
      is_genre == "TV Horror",
      "Horror Movies"
      ,ifelse(
      is_genre == "TV Dramas",
      "Dramas"
      ,ifelse(
      is_genre == "TV Comedies",
      "Comedies",
      ifelse(
      is_genre == "Kids' TV",
      "Children & Family Movies"
      ,
      is_genre
    ))))))))))))))


genre_graph <- nettit_long %>% 
  group_by(genderfin, genre_fin) %>% 
  summarize(n=n()) %>% 
  filter(!is.na(genre_fin)) %>% 
  ungroup() %>% 
  group_by(genre_fin) %>% 
  mutate(n_tog=sum(n)) %>% 
  filter(n_tog>10) %>% 
  ungroup() %>% 
  group_by(genre_fin) %>% 
  mutate(
    share = round(((n / n_tog)*100),2))

ggplot(genre_graph, aes(x = genre_fin, y=n, fill = genderfin)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(data = subset(genre_graph, genderfin == "Female"), 
            aes(label = paste0(sprintf("%.2f", share), "%"), y = n_tog + 30), 
            position = position_stack(), 
            hjust=0.5, size = 2.5, color = "black") +
  scale_fill_manual(values=c("#FF0099","#3399FF"))+
  labs(x = "Genre", y = "Frequency", fill = "Gender") +
    theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  theme(text = element_text(family = "sans"))
```
### Gender Differences by Country
```{r}
nettit_cou <- nettit %>% 
  filter(country!="")

nettit_cou <- separate(nettit_cou, country, into = paste0("country_", 1:12), sep = ", ", fill = "right")

nettit_long_cou <- nettit_cou %>%
  pivot_longer(starts_with("country_"), names_to = "country", values_to = "is_country")


country_graph <- nettit_long_cou %>% 
  group_by(genderfin, is_country) %>% 
  summarize(n=n()) %>% 
  filter(!is.na(is_country)) %>% 
  ungroup() %>% 
  group_by(is_country) %>% 
  mutate(n_tog=sum(n)) %>% 
  mutate(country_fin=ifelse(n_tog>50, is_country, "other")) %>% 
  ungroup()
  
country_graph <- country_graph %>% 
  group_by(genderfin, country_fin) %>%
    summarize(n=sum(n)) %>% 
  ungroup() %>% 
  group_by(country_fin) %>% 
  mutate(n_togx=sum(n)) %>% 
  mutate(
    share = round(((n / n_togx)*100),2))

country_graph$country_fin <- as.factor(country_graph$country_fin)
country_graph$country_fin <- fct_relevel(country_graph$country_fin, "other", after = Inf)

# Plot the frequencies
ggplot(data=country_graph, aes(x = country_fin, y=n, fill = genderfin)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(data = subset(country_graph, genderfin == "Female"), 
            aes(label = paste0(sprintf("%.2f", share), "%"), y = n_togx + 30), 
            position = position_stack(), 
            hjust=0.5, size = 2.3, color = "black") +
  scale_fill_manual(values=c("#FF0099","#3399FF", "#666666"))+
  labs(x = "Country", y = "Frequency", fill = "Gender") +
    theme_classic()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))# +
```


```{r}
# Group Variables
showvsfilm <- nettit %>% 
  group_by(genderfin, type) %>% 
  summarise(count = n()) %>% 
  ungroup()

# Get percentages
showvsfilm_p <- showvsfilm %>% 
  filter(genderfin!="Unknown") %>% 
  group_by(type) %>% 
  mutate(sumcount = sum(count)) %>% 
  group_by(type) %>% 
  mutate(femshare= round(((count/sumcount)*100),2))
```
### Shares by Gender and Type
```{r}
# Plot results
ggplot(showvsfilm_p, aes(x = type, y = femshare, fill = genderfin)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Anteil der Titel nach Type und Geschlecht",
       x = "Type",
       y = "Anzahl der Titel",
       fill = "Geschlecht") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```


## TV-Show Duration (seasons) by Directors Gender
```{r}
# Filter only TV Shows
filtered_data <- nettit %>%
  filter(type == "TV Show", genderfin != "Unknown")

# Delete Season
filtered_data$duration <- sub("\\s.*", "", filtered_data$duration)
filtered_data$duration <- as.numeric(filtered_data$duration)
```

```{r}
duration_by_gender <- filtered_data %>% 
  group_by(duration, genderfin) %>% 
  summarise(count = n(), .groups = 'drop') 
```


```{r}
ggplot(filtered_data, aes(x = release_year, y = duration, fill = genderfin)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Gesamtdauer nach Geschlecht",
       x = "Jahr",
       y = "Gesamtdauer",
       fill = "Geschlecht") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}

duration_frequency <- filtered_data %>%
  group_by(genderfin, duration) %>%
  summarise(count = n(), .groups = 'drop') 

duration_frequency$duration <- as.factor(duration_frequency$duration)

```

```{r}

ggplot(duration_frequency, aes(x = duration, y = count, fill = genderfin)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Duration by gender",
       x = "Dauer",
       y = "Häufigkeit",
       fill = "Geschlecht") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
## Number of TV-Shows by Seasons
```{r}
# Get an row for each season
data_expanded <- filtered_data %>%
  rowwise() %>%
  do(data.frame(serie = .$title, staffel = 1:.$duration, genderfin = .$genderfin, max_dur= .$duration))

# Get a count
data_expanded <- data_expanded %>%
  group_by(serie) %>%
  mutate(count = 1)

# Group by Staffel and genderfin
data_expanded<- data_expanded %>% 
  group_by(staffel, genderfin) %>% 
  mutate(n=n())
```

```{r}

duration_p <- data_expanded %>%
  group_by(staffel) %>%
  mutate(total_count = n()) %>%
  group_by(genderfin, staffel) %>%
  mutate(genderfin_count = n()) %>%
  mutate(genderfin_share = round((genderfin_count / total_count) * 100, 2))
```

```{r}
ggplot(duration_p, aes(x = staffel, y= n, fill = genderfin))+
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(x = "Season",
       y = "Number of TV- Shows",
       fill = "Gender")+
  geom_text(data = subset(duration_p, genderfin == "Female"), 
            aes(label = paste0(sprintf("%.2f", genderfin_share), "%"), y = n + 2),       
            position = position_dodge(), 
            hjust=1, size = 2, color = "black") +
  scale_fill_manual(values=c("#FF0099","#3399FF", "#666666"))+
  scale_x_continuous(breaks = seq(0, 15, by = 1))+
  theme_classic() +
  theme(axis.text.x = element_text(hjust = 1))

```